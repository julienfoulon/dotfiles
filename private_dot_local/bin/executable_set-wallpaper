#!/bin/sh

if [ -z "$XDG_PICTURES_DIR" ] && [ -f "$HOME/.config/user-dirs.dirs" ]; then
  . "$HOME/.config/user-dirs.dirs"
fi
if [ -r "$HOME/.local/bin/wallpaper_common" ]; then
  . "$HOME/.local/bin/wallpaper_common"
else
  . "$(dirname "$0")/wallpaper_common"
fi

WALLPAPER_DIR="$(wallpaper_dir)"

if ! command -v swww >/dev/null 2>&1; then
  echo "swww not found in PATH" >&2
  exit 1
fi

if ! command -v find-image >/dev/null 2>&1; then
  echo "find-image not found in PATH" >&2
  exit 1
fi

ensure_wallpaper_dir

img=$(
  cd "$WALLPAPER_DIR" && find-image
)

if [ -z "$img" ]; then
  exit 0
fi

cursor_pos=$(hyprctl cursorpos 2>/dev/null | grep -E '^[0-9]' || echo "0,0")
cursor_x=${cursor_pos%,*}
cursor_y=${cursor_pos#*,}

output=""
if command -v jq >/dev/null 2>&1; then
  output=$(
    hyprctl monitors -j 2>/dev/null | jq -r \
      --argjson x "$cursor_x" \
      --argjson y "$cursor_y" \
      '.[] | select(($x >= .x) and ($x < (.x + .width)) and ($y >= .y) and ($y < (.y + .height))) | .name' \
      | head -n 1
  )
fi

set -- swww img \
  --transition-fps 60 \
  --transition-type grow \
  --transition-duration .75 \
  --transition-bezier 1,0.9,1,0.7 \
  --invert-y \
  --transition-pos "$cursor_pos"

if [ -n "$output" ]; then
  set -- "$@" -o "$output"
fi

set -- "$@" "$WALLPAPER_DIR/$img"

"$@"
