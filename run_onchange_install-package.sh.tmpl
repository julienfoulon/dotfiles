#!/bin/env bash
{{- if eq .chezmoi.os "linux" }}
echo "Chezmoi, install {{ .chezmoi.os }} packages ({{- .chezmoi.osRelease.id -}})"
{{- if eq .chezmoi.osRelease.id "arch" }}
sudo pacman --needed -Suy{{ range .packages.linux.arch.pacman }} {{ . | quote }}{{- end }}

# install yay if necessary
if ! command -v yay > /dev/null 2>&1; then
    YAY_DIR="${YAY_DIR:={{- .chezmoi.homeDir -}}/git/yay}"
    mkdir -p "$YAY_DIR"
    pushd "$YAY_DIR"
    cd ..
    git clone https://aur.archlinux.org/yay.git
    cd yay
    makepkg -si
    popd
fi

yay --needed -S {{ range .packages.linux.arch.yay }} {{ . | quote }}{{- end }}

# Ensure cargo is available on Arch
if ! command -v cargo > /dev/null 2>&1; then
    sudo pacman --needed -S rustup
    rustup toolchain install stable
    rustup default stable
    export PATH="{{- .chezmoi.homeDir -}}/.cargo/bin:$PATH"
fi


{{ if .chezmoi.config.data.laptop -}}
sudo pacman --needed -Suy{{ range .laptoppackages.linux.arch.pacman }} {{ . | quote }}{{- end }}
yay --needed -S {{ range .laptoppackages.linux.arch.yay }} {{ . | quote }}{{- end }}
{{- end }}

{{ if and .chezmoi.config.data.home .chezmoi.config.data.laptop -}}
yay --needed -S {{ range .homelaptoppackages.linux.arch.yay }} {{ . | quote }}{{- end }}
{{- end }}

{{ if or .chezmoi.config.data.home .chezmoi.config.data.laptop -}}
yay --needed -S {{ range .guipackages.linux.arch.yay }} {{ . | quote }}{{- end }}
for svc in cups.service avahi-daemon.service cups-browsed.service; do
    if systemctl is-enabled --quiet "$svc"; then
        echo "$svc: already enabled"
    else
        sudo systemctl enable "$svc"
    fi
    if systemctl is-active --quiet "$svc"; then
        echo "$svc: already active"
    else
        sudo systemctl start "$svc"
    fi
done

{{ if .chezmoi.config.data.laptop -}}
SDDM_CONFIG_DIR="/etc/sddm.conf.d"
sudo install -d -m 755 "$SDDM_CONFIG_DIR"
sudo install -m 644 "{{ .chezmoi.sourceDir }}/assets/sddm/10-wayland.conf" "$SDDM_CONFIG_DIR/10-wayland.conf"
sudo install -m 644 "{{ .chezmoi.sourceDir }}/assets/sddm/20-theme.conf" "$SDDM_CONFIG_DIR/20-theme.conf"
if yay -Qq sddm >/dev/null 2>&1; then
    if systemctl is-enabled --quiet sddm.service; then
        echo "sddm: already enabled"
    else
        sudo systemctl enable sddm.service
    fi
fi
{{- end }}
{{- end }}

{{- else if eq .chezmoi.osRelease.id "ubuntu" }}
sudo apt-get update -y
sudo apt-get install -y software-properties-common
sudo add-apt-repository -y universe
sudo apt-get update -y
sudo apt-get install -y{{ range .packages.linux.ubuntu.apt }} {{ . | quote }}{{- end }}
{{- if .packages.linux.ubuntu.cargo }}
# Remove any apt-provided duplicates of cargo-managed packages (ignore missing).
sudo apt-get remove -y --ignore-missing{{ range .packages.linux.ubuntu.cargo }} {{ . | quote }}{{- end }}
{{- end }}

ensure_cargo() {
    if ! command -v cargo > /dev/null 2>&1; then
        sudo apt-get install -y curl
        curl https://sh.rustup.rs -sSf | sh -s -- -y
        export PATH="{{- .chezmoi.homeDir -}}/.cargo/bin:$PATH"
    fi
}

NEOVIM_DIR="/opt/nvim-linux-x86_64"
NEOVIM_TARBALL="/tmp/nvim-linux-x86_64.tar.gz"
if ! command -v curl > /dev/null 2>&1; then
    sudo apt-get install -y curl
fi
curl -L -o "$NEOVIM_TARBALL" "https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz"
sudo rm -rf "$NEOVIM_DIR"
sudo tar -C /opt -xzf "$NEOVIM_TARBALL"
rm -f "$NEOVIM_TARBALL"
mkdir -p "{{- .chezmoi.homeDir -}}/.local/bin"
ln -sf "$NEOVIM_DIR/bin/nvim" "{{- .chezmoi.homeDir -}}/.local/bin/nvim"

{{- if .chezmoi.config.data.laptop }}
sudo apt-get install -y{{ range .laptoppackages.linux.ubuntu.apt }} {{ . | quote }}{{- end }}
{{- end }}

{{- if and .chezmoi.config.data.home .chezmoi.config.data.laptop }}
sudo apt-get install -y{{ range .homelaptoppackages.linux.ubuntu.apt }} {{ . | quote }}{{- end }}
{{- end }}

{{- if .chezmoi.config.data.laptop }}
sudo apt-get install -y{{ range .guipackages.linux.ubuntu.apt }} {{ . | quote }}{{- end }}
{{- end }}

{{- if .packages.linux.ubuntu.cargo }}
ensure_cargo
cargo install --locked{{ range .packages.linux.ubuntu.cargo }} {{ . | quote }}{{- end }}
{{- end }}

FZF_DIR="{{- .chezmoi.homeDir -}}/.local/share/fzf"
if [ -d "$FZF_DIR/.git" ]; then
    git -C "$FZF_DIR" fetch --depth 1 origin
    git -C "$FZF_DIR" reset --hard FETCH_HEAD
else
    git clone --depth 1 https://github.com/junegunn/fzf.git "$FZF_DIR"
fi
"$FZF_DIR/install" --bin


if command -v zsh > /dev/null 2>&1; then
    CURRENT_SHELL="$(getent passwd "{{ .chezmoi.username }}" | cut -d: -f7)"
    ZSH_SHELL="$(command -v zsh)"
    if [ "$CURRENT_SHELL" != "$ZSH_SHELL" ]; then
        echo "User shell is not zsh; switching default shell to zsh."
        sudo chsh -s "$ZSH_SHELL" "{{ .chezmoi.username }}"
    fi
fi

{{- else }}
echo "unsupported linux variant"
{{- end }}
{{- else }}
echo "unsupported OS"
exit 1
{{- end }}
